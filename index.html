<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Smart Bin Capture</title>
  <style>
    :root{--bg1:#4f46e5;--bg2:#7c3aed}
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));min-height:100vh;display:grid;place-items:center}
    .wrap{width:100%;max-width:420px;padding:16px}
    .card{background:#fff;border-radius:18px;padding:16px;box-shadow:0 18px 36px rgba(0,0,0,.15)}
    h1{margin:0 0 8px;font-size:18px;text-align:center}
    .subtitle{margin:0 0 12px;font-size:12px;text-align:center;color:#6b7280}
    video{display:block;width:100%;max-height:220px;object-fit:cover;border-radius:12px;background:#f3f4f6;border:1px solid #e5e7eb}
    
    /* Popup overlay styles */
    .popup-overlay{
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.8);z-index:1000;
      display:flex;align-items:center;justify-content:center;
      opacity:0;visibility:hidden;
      transition:opacity 0.3s ease,visibility 0.3s ease;
    }
    .popup-overlay.show{opacity:1;visibility:visible}
    .popup-content{
      background:#fff;border-radius:18px;padding:20px;
      max-width:90%;max-height:90%;box-shadow:0 20px 40px rgba(0,0,0,0.3);
      transform:scale(0.9);transition:transform 0.3s ease;
    }
    .popup-overlay.show .popup-content{transform:scale(1)}
    .popup-image{
      max-width:100%;max-height:60vh;border-radius:12px;
      display:block;margin:0 auto;
    }
    .popup-text{
      text-align:center;margin-top:12px;font-size:14px;color:#374151;
    }
    .popup-timer{
      text-align:center;margin-top:8px;font-size:12px;color:#6b7280;
    }
    
    .btn{width:100%;display:inline-flex;align-items:center;justify-content:center;gap:10px;margin-top:12px;border:0;border-radius:14px;
      padding:14px 16px;font-size:16px;color:#fff;background:linear-gradient(45deg,var(--bg1),var(--bg2));
      box-shadow:0 8px 18px rgba(79,70,229,.35);cursor:pointer;transition:transform .12s ease,opacity .12s ease}
    .btn:active{transform:translateY(1px) scale(.995)}
    .btn[disabled]{opacity:.6;cursor:not-allowed;box-shadow:none}
    .spinner{width:18px;height:18px;border:3px solid rgba(255,255,255,.35);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .msg{margin-top:12px;border-radius:12px;padding:12px;font-size:14px;display:none}
    .msg.ok{display:block;background:#dcfce7;border:1px solid #86efac;color:#065f46}
    .msg.err{display:block;background:#fee2e2;border:1px solid #fecaca;color:#7f1d1d}
    .hint{margin-top:8px;color:#6b7280;font-size:11px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Smart Trash Bin</h1>
      <p class="subtitle">Camera is always live â€¢ tap to capture & send</p>

      <!-- Live camera view -->
      <video id="video" autoplay playsinline muted></video>
      <canvas id="canvas" style="display:none;"></canvas>

      <button id="takeBtn" class="btn">
        <span id="btnIcon" aria-hidden="true">ðŸ“¸</span>
        <span id="btnText">Capture & Send</span>
      </button>

      <div id="msg" class="msg" role="status" aria-live="polite"></div>
      <div class="hint" id="hint">If the camera doesn't appear, make sure you opened this page over HTTPS or localhost and allowed camera access.</div>
    </div>
  </div>

  <!-- Popup for captured image preview -->
  <div id="popup" class="popup-overlay">
    <div class="popup-content">
      <img id="popupImage" class="popup-image" alt="Captured image" />
      <div id="popupText" class="popup-text">Image captured and sent!</div>
      <div id="popupTimer" class="popup-timer">Closing in 3 seconds...</div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const params = new URLSearchParams(location.search);
    const TRASH_BIN_ID = Number(params.get("binId")) || 1;
    const API_URL = "https://physically-holy-longhorn.ngrok-free.app/trashBin/type";

    // ====== ELEMENTS ======
    const takeBtn = document.getElementById("takeBtn");
    const btnText = document.getElementById("btnText");
    const btnIcon = document.getElementById("btnIcon");
    const msgBox  = document.getElementById("msg");
    const video   = document.getElementById("video");
    const canvas  = document.getElementById("canvas");
    const hint    = document.getElementById("hint");
    const popup   = document.getElementById("popup");
    const popupImage = document.getElementById("popupImage");
    const popupText = document.getElementById("popupText");
    const popupTimer = document.getElementById("popupTimer");

    let stream = null;
    let cameraReady = false;

    // ====== CAMERA HELPERS ======
    async function tryGetUserMedia(constraints) {
      return navigator.mediaDevices.getUserMedia(constraints);
    }

    async function startCamera() {
      clearMsg();

      if (!navigator.mediaDevices?.getUserMedia) {
        showError("Camera not supported in this browser/webview.");
        return false;
      }

      const attempts = [
        { video: { facingMode: { ideal: "environment" }, width: { ideal: 640 }, height: { ideal: 480 } }, audio: false },
        { video: { facingMode: "environment" }, audio: false },
        { video: true, audio: false } // final fallback
      ];

      for (const c of attempts) {
        try {
          stream = await tryGetUserMedia(c);
          video.srcObject = stream;

          // Ensure playback begins after metadata is loaded
          if (video.readyState < 2) {
            await new Promise(r => { video.onloadeddata = r; });
          }
          await video.play().catch(()=>{}); // in case autoplay needs muted (we already set muted)
          cameraReady = true;
          hint.style.display = "none";
          return true;
        } catch (err) {
          // continue to next attempt
          console.debug("getUserMedia failed with constraints:", c, err);
        }
      }

      showError("Unable to access the camera. Check HTTPS and permissions.");
      return false;
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      cameraReady = false;
    }

    // ====== POPUP HELPERS ======
    function showPopup(imageDataURL, message = "Image captured and sent!") {
      popupImage.src = imageDataURL;
      popupText.textContent = message;
      popup.classList.add("show");
      
      // Start countdown timer
      let countdown = 3;
      popupTimer.textContent = `Closing in ${countdown} seconds...`;
      
      const timer = setInterval(() => {
        countdown--;
        if (countdown > 0) {
          popupTimer.textContent = `Closing in ${countdown} seconds...`;
        } else {
          clearInterval(timer);
          hidePopup();
        }
      }, 1000);
    }

    function hidePopup() {
      popup.classList.remove("show");
    }

    // ====== CAPTURE + SEND ======
    async function captureAndSend() {
      // If camera not started, start it first
      if (!cameraReady) {
        const ok = await startCamera();
        if (ok) setOk("Camera started. Tap again to capture & send.");
        return;
      }

      clearMsg();

      // Draw current frame to canvas (scale to ~640w to reduce payload)
      const targetW = 640;
      const scale = targetW / video.videoWidth;
      const w = Math.round(video.videoWidth * scale);
      const h = Math.round(video.videoHeight * scale);

      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, w, h);

      // Get image data
      const dataURL = canvas.toDataURL("image/jpeg", 0.8);

      // Prepare payload
      const base64Data = dataURL.split(",")[1];
      const payload = {
        image_b64: base64Data,
        actualValue: "n/a",
        trashBinId: TRASH_BIN_ID,
        return_reason: true
      };

      setLoading(true);
      try {
        const res = await fetch(API_URL, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        if (res.ok) {
          // Show popup with captured image and success message
          showPopup(dataURL, "Success: " + text);
          setOk("Image sent successfully!");
        } else {
          showError("API Error (" + res.status + "): " + text);
        }
      } catch (err) {
        showError("Network Error: " + err.message);
      } finally {
        setLoading(false);
        // Keep camera running for continuous use
      }
    }

    // ====== UI ======
    function setLoading(isLoading) {
      takeBtn.disabled = isLoading;
      if (isLoading) {
        btnIcon.innerHTML = "";
        btnIcon.className = "spinner";
        btnText.textContent = "Sendingâ€¦";
      } else {
        btnIcon.className = "";
        btnIcon.innerHTML = "ðŸ“¸";
        btnText.textContent = "Capture & Send";
      }
    }

    function setOk(text) {
      msgBox.className = "msg ok";
      msgBox.textContent = text;
      msgBox.style.display = "block";
    }

    function showError(text) {
      msgBox.className = "msg err";
      msgBox.textContent = text;
      msgBox.style.display = "block";
    }

    function clearMsg() {
      msgBox.style.display = "none";
      msgBox.textContent = "";
      msgBox.className = "msg";
    }

    // ====== EVENTS ======
    takeBtn.addEventListener("click", captureAndSend);
    
    // Close popup when clicking overlay
    popup.addEventListener("click", (e) => {
      if (e.target === popup) {
        hidePopup();
      }
    });

    // Start camera immediately when page loads
    window.addEventListener("load", () => {
      startCamera();
    });

    window.addEventListener("pagehide", stopCamera);
    window.addEventListener("beforeunload", stopCamera);
  </script>
</body>
</html>
